admuser@ceshtjeligjore:~$ sudo -i
[sudo] password for admuser: 
root@ceshtjeligjore:~# #!/bin/bash

cd /opt/ceshtje-ligjore

echo "DEPLOYING FULL REPLIT ENVIRONMENT:"
echo "- Complete React application with TypeScript"
echo "- Full Express.js backend with all APIs"
echo "- PostgreSQL database with Drizzle ORM"
echo "- Authentication system"
echo "- All shadcn/ui components"
echo "- Email notifications"
echo "- Data export functionality"
echo "- Complete Albanian interface"

echo "1. Stop current simplified version:"
pm2 stop albpetrol-legal
pm2 delete albpetrol-legal

echo "2. Backup current files:"
mv dist dist_backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "No dist to backup"

echo "3. Pull latest code from GitHub (complete version):"
git fetch origin
entication"res: Full React app, all APIs, Albanian interface, data exports, auth
DEPLOYING FULL REPLIT ENVIRONMENT:
- Complete React application with TypeScript
- Full Express.js backend with all APIs
- PostgreSQL database with Drizzle ORM
- Authentication system
- All shadcn/ui components
- Email notifications
- Data export functionality
- Complete Albanian interface
1. Stop current simplified version:
[PM2] Applying action stopProcessId on app [albpetrol-legal](ids: [ 0 ])
[PM2] [albpetrol-legal](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 0    │ stopped   │ 0%       │ 0b       │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Applying action deleteProcessId on app [albpetrol-legal](ids: [ 0 ])
[PM2] [albpetrol-legal](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
2. Backup current files:
3. Pull latest code from GitHub (complete version):
HEAD is now at 7f7ee3c feat: configure git authentication for deployment
From https://github.com/thanasdinaku/ceshtje_ligjore
 * branch            main       -> FETCH_HEAD
Already up to date.
4. Install ALL dependencies (including dev dependencies):
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 111 packages, removed 2 packages, and audited 766 packages in 7s

95 packages are looking for funding
  run `npm fund` for details

6 vulnerabilities (5 moderate, 1 high)

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
5. Build complete React application:

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.19 building for production...
✓ 2399 modules transformed.
dist/public/index.html                                         1.09 kB │ gzip:   0.62 kB
dist/public/assets/Albpetrol.svg_1754604323425-C1lBmiZp.png   93.96 kB
dist/public/assets/index-DPP8Sud3.css                        156.99 kB │ gzip:  25.08 kB
dist/public/assets/index-BQ4hcx7k.js                         815.41 kB │ gzip: 242.37 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 5.77s

  dist/index.js  133.4kb

⚡ Done in 8ms
6. Create production environment file:
7. Update database schema:

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/opt/ceshtje-ligjore/drizzle.config.ts'
Using 'pg' driver for database querying
[⣷] Pulling schema from database...
error: password authentication failed for user "postgres"
    at /opt/ceshtje-ligjore/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async Object.query (/opt/ceshtje-ligjore/node_modules/drizzle-kit/bin.cjs:78355:26)
    at async fromDatabase2 (/opt/ceshtje-ligjore/node_modules/drizzle-kit/bin.cjs:19095:25) {
  length: 104,
  severity: 'FATAL',
  code: '28P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'auth.c',
  line: '323',
  routine: 'auth_failed'
}
8. Create complete PM2 ecosystem config:
9. Start complete application with PM2:
[PM2][WARN] Applications albpetrol-legal not running, starting...
[PM2] App [albpetrol-legal] launched (1 instances)
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 0    │ online    │ 0%       │ 19.3mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
10. Wait for startup and check status:
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 0    │ online    │ 0%       │ 77.6mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[TAILING] Tailing last 5 lines for [albpetrol-legal] process (change the value with --lines option)
/var/log/pm2/albpetrol-legal-out-0.log last 5 lines:
0|albpetro | 2025-08-21T07:49:49: 🔗 External access: http://10.5.20.31:5000
0|albpetro | 2025-08-21T11:49:18: 🚀 Starting Albpetrol Legal System (Full Application)...
0|albpetro | 2025-08-21T11:49:18: ✅ Albpetrol Legal System (Full) running on port 5000
0|albpetro | 2025-08-21T11:49:18: 🌐 Server accessible at http://0.0.0.0:5000
0|albpetro | 2025-08-21T11:49:18: 🔗 External access: http://10.5.20.31:5000

/var/log/pm2/albpetrol-legal-error-0.log last 5 lines:
0|albpetro | 2025-08-21T11:55:53:     at ModuleLoader.resolve (node:internal/modules/esm/loader:574:38)
0|albpetro | 2025-08-21T11:55:53:     at ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:236:38)
0|albpetro | 2025-08-21T11:55:53:     at ModuleJob._link (node:internal/modules/esm/module_job:130:49) {
0|albpetro | 2025-08-21T11:55:53:   code: 'ERR_MODULE_NOT_FOUND'
0|albpetro | 2025-08-21T11:55:53: }

11. Test complete application:
Health API: 000
Auth API: 000
Frontend: 000
12. Update Nginx for complete application:
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
DEPLOYMENT COMPLETE!
✅ Complete Replit environment deployed to Ubuntu
🌐 Access: http://10.5.20.31
Features: Full React app, all APIs, Albanian interface, data exports, authentication
root@ceshtjeligjore:/opt/ceshtje-ligjore# 