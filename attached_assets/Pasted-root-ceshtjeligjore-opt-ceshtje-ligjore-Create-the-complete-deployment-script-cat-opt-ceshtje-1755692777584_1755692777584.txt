root@ceshtjeligjore:/opt/ceshtje-ligjore# # Create the complete deployment script
cat > /opt/ceshtje-ligjore/complete_ubuntu_deployment.sh << 'DEPLOY_SCRIPT'
#!/bin/bash

echo "🚀 Complete Ubuntu Deployment for Albpetrol Legal System"
echo "======================================================="

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "❌ Please run as root: sudo bash $0"
    exit 1
fi

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "❌ Error: Not in application directory"
    echo "Please run from /opt/ceshtje-ligjore"
    exit 1
fi

echo "📥 Pulling latest changes from GitHub..."
git pull origin main

./complete_ubuntu_deployment.shomplete_ubuntu_deployment.shk with: pm2 logs albp
🚀 Complete Ubuntu Deployment for Albpetrol Legal System
=======================================================
📥 Pulling latest changes from GitHub...
From https://github.com/thanasdinaku/ceshtje_ligjore
 * branch            main       -> FETCH_HEAD
Already up to date.
📦 Installing dependencies...

up to date, audited 655 packages in 1s

80 packages are looking for funding
  run `npm fund` for details

1 high severity vulnerability

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
🔨 Building application...

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

failed to load config from /opt/ceshtje-ligjore/vite.config.ts
error during build:
Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'vite' imported from /opt/ceshtje-ligjore/node_modules/.vite-temp/vite.config.ts.timestamp-1755692735337-1866b883cab1c.mjs
    at packageResolve (node:internal/modules/esm/resolve:873:9)
    at moduleResolve (node:internal/modules/esm/resolve:946:18)
    at defaultResolve (node:internal/modules/esm/resolve:1188:11)
    at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:642:12)
    at #cachedDefaultResolve (node:internal/modules/esm/loader:591:25)
    at ModuleLoader.resolve (node:internal/modules/esm/loader:574:38)
    at ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:236:38)
    at ModuleJob._link (node:internal/modules/esm/module_job:130:49)
📝 Setting up environment configuration...
🗄️ Setting up database schema...
Need to install the following packages:
drizzle-kit@0.31.4
Ok to proceed? (y) y

npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is
No config path provided, using default 'drizzle.config.ts'
Reading config file '/opt/ceshtje-ligjore/drizzle.config.ts'
Cannot find module 'drizzle-kit'
Require stack:
- /opt/ceshtje-ligjore/drizzle.config.ts
- /root/.npm/_npx/7c7555b0b81cc7e0/node_modules/drizzle-kit/bin.cjs
📧 Updating admin email to it.system@albpetrol.al...
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "albpetrol_user"
Database update will be done manually
📁 Creating logs directory...
🔄 Stopping existing PM2 processes...
[PM2] Applying action stopProcessId on app [albpetrol-legal](ids: [ 0 ])
[PM2] [albpetrol-legal](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 2    │ stopped   │ 0%       │ 0b       │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Applying action deleteProcessId on app [albpetrol-legal](ids: [ 0 ])
[PM2] [albpetrol-legal](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
🚀 Starting application with PM2...
[PM2][WARN] Applications albpetrol-legal not running, starting...
[PM2] App [albpetrol-legal] launched (1 instances)
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 0    │ online    │ 0%       │ 9.5mb    │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
💾 Saving PM2 configuration...
[PM2] Saving current process list...
[PM2] Successfully saved in /root/.pm2/dump.pm2
🔧 Setting up PM2 auto-start...
[PM2] Init System found: systemd
Platform systemd
Template
[Unit]
Description=PM2 process manager
Documentation=https://pm2.keymetrics.io/
After=network.target

[Service]
Type=forking
User=root
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=PM2_HOME=/root/.pm2
PIDFile=/root/.pm2/pm2.pid
Restart=on-failure

ExecStart=/usr/lib/node_modules/pm2/bin/pm2 resurrect
ExecReload=/usr/lib/node_modules/pm2/bin/pm2 reload all
ExecStop=/usr/lib/node_modules/pm2/bin/pm2 kill

[Install]
WantedBy=multi-user.target

Target path
/etc/systemd/system/pm2-root.service
Command list
[ 'systemctl enable pm2-root' ]
[PM2] Writing init configuration in /etc/systemd/system/pm2-root.service
[PM2] Making script booting at startup...
[PM2] [-] Executing: systemctl enable pm2-root...
[PM2] [v] Command successfully executed.
+---------------------------------------+
[PM2] Freeze a process list on reboot via:
$ pm2 save

[PM2] Remove init script via:
$ pm2 unstartup systemd

✅ Deployment completed!

📊 Application Status:
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ albpetrol-legal    │ fork     │ 0    │ online    │ 0%       │ 59.4mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

🌐 Application URLs:
   - http://localhost:5000
   - http://10.5.20.31:5000
   - http://legal.albpetrol.al (if Cloudflare tunnel configured)

📧 Admin email: it.system@albpetrol.al

🔧 Useful commands:
   pm2 status                    - Check status
   pm2 logs albpetrol-legal      - View logs
   pm2 restart albpetrol-legal   - Restart app

🔍 Testing application...
✅ Application is responding on port 5000
root@ceshtjeligjore:/opt/ceshtje-ligjore# 
