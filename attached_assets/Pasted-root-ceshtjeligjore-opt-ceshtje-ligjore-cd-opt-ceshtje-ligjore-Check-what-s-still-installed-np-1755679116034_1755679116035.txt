root@ceshtjeligjore:/opt/ceshtje-ligjore# cd /opt/ceshtje-ligjore

# Check what's still installed
npm ls | grep -i neon

# Completely remove node_modules and package-lock to ensure clean state
rm -rf node_modules package-lock.json

# Remove any cached build artifacts
rm -rf dist/ .vite/

# Reinstall only the dependencies we need
npm install

# Check that neon is not installed
npm ls | grep -i neon || echo "✅ No Neon packages found"

# Rebuild the production server completely
npx esbuild server/production.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/production-clean.js

# Test the completely rebuilt server
export NODE_ENV=production
export PORT=5000
export DATABASE_URL="postgresql://ceshtje_user:Albpetrol2025@localhost:5432/ceshtje_ligjore"
export SESSION_SECRET="albpetrol_ceshtje_ligjore_secret_2025_production_ready"
export ISSUER_URL="https://replit.com/oidc"

echo "Testing clean rebuilt server..."
timeout 15s node dist/production-clean.js > clean_test.log 2>&1 &
SERVER_PID=$!
sleep 10

# Test server response
curl -I http://localhost:5000/ && echo "✅ SERVER RESPONDING!" || echo "❌ Server not responding"

echo "=== CLEAN BUILD TEST COMPLETE ===" remaining issues"25_production_ready',htje_ligjore',
npm warn deprecated node-domexception@1.0.0: Use your platform's native DOMException instead

added 654 packages, and audited 655 packages in 2m

80 packages are looking for funding
  run `npm fund` for details

1 high severity vulnerability

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
✅ No Neon packages found

  dist/production-clean.js  131.4kb

⚡ Done in 14ms
Testing clean rebuilt server...
[1] 15221
[1]+  Exit 1                  timeout 15s node dist/production-clean.js > clean_test.log 2>&1
curl: (7) Failed to connect to localhost port 5000 after 0 ms: Couldn't connect to server
❌ Server not responding
=== CLEAN SERVER LOGS ===
node:internal/modules/esm/resolve:873
  throw new ERR_MODULE_NOT_FOUND(packageName, fileURLToPath(base), null);
        ^

Error [ERR_MODULE_NOT_FOUND]: Cannot find package '@neondatabase/serverless' imported from /opt/ceshtje-ligjore/dist/production-clean.js
    at packageResolve (node:internal/modules/esm/resolve:873:9)
    at moduleResolve (node:internal/modules/esm/resolve:946:18)
    at defaultResolve (node:internal/modules/esm/resolve:1188:11)
    at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:642:12)
    at #cachedDefaultResolve (node:internal/modules/esm/loader:591:25)
    at ModuleLoader.resolve (node:internal/modules/esm/loader:574:38)
    at ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:236:38)
    at ModuleJob._link (node:internal/modules/esm/module_job:130:49) {
  code: 'ERR_MODULE_NOT_FOUND'
}

Node.js v20.19.4
Still not working - checking for remaining issues
=== CLEAN BUILD TEST COMPLETE ===
root@ceshtjeligjore:/opt/ceshtje-ligjore# 
