root@ceshtjeligjore:/opt/ceshtje-ligjore# cd /opt/ceshtje-ligjore

# Install missing development dependencies
npm install --save-dev vite esbuild typescript

# Now rebuild with all dependencies available
npm run build

# Verify build success
ls -la dist/index.js

# Check if the built file contains any neon references
grep -q "neondatabase" dist/index.js && echo "ERROR: Still contains Neon code!" || echo "SUCCESS: No Neon code found"

# Test the application with environment variables
export NODE_ENV=production
export PORT=5000
export DATABASE_URL="postgresql://ceshtje_user:Albpetrol2025@localhost:5432/ceshtje_ligjore"
export SESSION_SECRET="albpetrol_ceshtje_ligjore_secret_2025_production_ready"
export ISSUER_URL="https://replit.com/oidc"

timeout 15s node dist/index.js > server_test4.log 2>&1 &
SERVER_PID=$!
sleep 8

# Test if server responds
curl -I http://localhost:5000/

echo "=== SERVER OUTPUT AFTER PROPER REBUILD ==="
cat server_test4.log | head -15

# Kill test server
kill $SERVER_PID 2>/dev/null

echo "=== TESTING REBUILT APPLICATION ==="

up to date, audited 585 packages in 6s

77 packages are looking for funding
  run `npm fund` for details

2 vulnerabilities (1 low, 1 high)

To address issues that do not require attention, run:
  npm audit fix

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

sh: 1: vite: not found
ls: cannot access 'dist/index.js': No such file or directory
grep: dist/index.js: No such file or directory
SUCCESS: No Neon code found
[1] 14439
[1]+  Exit 1                  timeout 15s node dist/index.js > server_test4.log 2>&1
curl: (7) Failed to connect to localhost port 5000 after 0 ms: Couldn't connect to server
=== SERVER OUTPUT AFTER PROPER REBUILD ===
node:internal/modules/cjs/loader:1215
  throw err;
  ^

Error: Cannot find module '/opt/ceshtje-ligjore/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1212:15)
    at Module._load (node:internal/modules/cjs/loader:1043:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.19.4
=== TESTING REBUILT APPLICATION ===
root@ceshtjeligjore:/opt/ceshtje-ligjore# 